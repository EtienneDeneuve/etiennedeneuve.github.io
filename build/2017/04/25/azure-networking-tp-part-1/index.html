<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="msvalidate.01" content="DE6C71A9BE4E011D01CC38799992B4A6"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-71551100-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-71551100-1');
    </script>

    
      <link rel="stylesheet" href="/css/style.css" type="text/css">
    

    <title>XYZ Blog</title>
    <script defer="defer" src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
    

    <script src="/js/script.js"></script>
  </head>
  <body class="position-relative" data-spy="scroll" data-target=".site-nav" data-offset="55">
    <nav class="site-nav family-sans navbar navbar-expand-md navbar-dark  sidebar sticky-top  py-0">
  <div class="container-fluid">
    <button type="button" class="navbar-toggler my-2 my-md-0" data-toggle="collapse" data-target="#myTogglerNav" aria-controls="myTogglerNav" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="navbar-brand text-uppercase">
      <a class="text-light" href="/"><i class="fas fa-cube mr-2"></i>XYZ Blog</a> 
    </div>

    <div class="collapse navbar-collapse text-center mt-0" id="myTogglerNav">
      <div class="navbar-nav ml-auto font-weight-regular text-uppercase">
        
        <a class="d-none nav-item nav-link" href="#page-hero">hero target</a>
        <a class="d-none nav-item nav-link" href="#main-content">nav target</a>
        
        <a class="nav-item nav-link font-weight-bold  text-light" href="/"><i class="fas fa-home"></i></a>
        
          <a class="nav-item nav-link" href="/posts/0/">posts</a>
          
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item text-capitalize" href="/about">About Me</a>
            <div class="dropdown-divider"></div><a class="dropdown-item text-capitalize" target="_blank" href="https://github.com/etiennedeneuve">
            <i class="fab fa-github text-secondary mr-2"></i>github
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://linkedin.com/in/etiennedeneuve">
            <i class="fab fa-linkedin text-secondary mr-2"></i>linkedin
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://twitter.com/etiennedinfo">
            <i class="fab fa-twitter text-secondary mr-2"></i>twitter
          </a></div>
        </div>
      </div>
      <div class="searchbox pl-2 py-2">
    <input
      type="text"
      v-model="query"
      class="form-control text-white border m-auto"
      :class="[isActive ? 'wide' : 'short']"
      @focus="isActive=true"
      @blur.prevent="handleBlur"
      ref="searchinput"
      style="background: transparent;"
      aria-describedby="searchinput"
      autocomplete="on"
    >
    <div v-if="query && isActive" class="position-absolute justify-content-center" style="top: 47px;">
      <div class="card bg-secondary">
        <ul class="list-group list-group-flush px-0" v-for="(item, index) in queried" :key="index">
          <li class="list-group-item">
            <a :href="item.url" class="d-flex text-secondary">
              <span class="pr-2" v-html="item.icon"></span>
              <span class="text-body text-left" v-html="item.title"></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
</div>
    </div>
  </div>
</nav>

    



<div class="post post-sidebar container-fluid">
  <div class="row justify-content-xl-center">
    

    
    <main class="main col">
      

      <p><a href="https://www.linkedin.com/in/lopesmickael">Mickael Lopes</a> et moi avons animé une session au Global Azure Bootcamp intitulée : &quot;Le réseau dans Azure : Cas d'usage et Retour d'expériences&quot;.</p>
<p>Les slides de  notre session sont dispo sur slideshare ici : <a href="https://www.slideshare.net/MickaelLOPES91/gab-le-rseau-dans-azure">Slideshare de Mickael</a></p>
<p>Comme prévu, voici des TP pour aller avec notre présentation, a faire vous même :)</p>
<h1 id="les-vnets-et-subnets">Les vNets et Subnets <a class="direct-link" href="#les-vnets-et-subnets"> </a></h1>
<p>Avant d'attaquer des éléments plus complexe, nous allons apprendre a créer un VNet avec un subnet avec les trois moyens disponibles sur Azure.</p>
<h2 id="powershell">Powershell <a class="direct-link" href="#powershell"> </a></h2>
<p>Avant de se lancer, commencez par installer votre station de travail convenablement avec la doc Microsoft qui va bien : <a href="https://docs.microsoft.com/fr-fr/powershell/azureps-cmdlets-docs">Powershell for Azure</a></p>
<p>Dans Azure, on commence toujours par créer un Resource Group donc :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">New<span class="token operator">-</span>AzureRmResourceGroup `</span><br><span class="highlight-line"><span class="token operator">-</span>Name RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span><span class="token function">PS</span> `</span><br><span class="highlight-line"><span class="token operator">-</span>Location northeurope</span></code></pre>
<p>Ensuite nous allons créer un vNet :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line"><span class="token variable">$vnetexo</span> = New<span class="token operator">-</span>AzureRmVirtualNetwork <span class="token operator">-</span>ResourceGroupName RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span><span class="token function">PS</span> `</span><br><span class="highlight-line"><span class="token operator">-</span>Name vnet<span class="token operator">-</span>test<span class="token operator">-</span><span class="token function">ps</span> `</span><br><span class="highlight-line"><span class="token operator">-</span>AddressPrefix 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token operator">/</span>24 `</span><br><span class="highlight-line"><span class="token operator">-</span>Location northeurope</span></code></pre>
<p>puis afin d'ajouter un subnet :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">Add<span class="token operator">-</span>AzureRmVirtualNetworkSubnetConfig <span class="token operator">-</span>Name psfrontend `</span><br><span class="highlight-line"><span class="token operator">-</span>VirtualNetwork <span class="token variable">$vnetexo</span> `</span><br><span class="highlight-line"><span class="token operator">-</span>AddressPrefix 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token operator">/</span>26</span><br><span class="highlight-line"><span class="token function">Set</span><span class="token operator">-</span>AzureRmVirtualNetwork <span class="token operator">-</span>VirtualNetwork <span class="token variable">$vnetexo</span></span></code></pre>
<h2 id="azure-cli-2.0">Azure CLI 2.0 <a class="direct-link" href="#azure-cli-2.0"> </a></h2>
<p>Comme pour la partie Powershell, suivez la doc d'installation de Azure CLI 2.0 ici : <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI 2.0</a><br>
Comme dans l'exemple précédent nous allons créer un Resource Group :</p>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">az group create <span class="token punctuation">\</span></span><br><span class="highlight-line">--name RG-Vnet-Exo-AZ <span class="token punctuation">\</span></span><br><span class="highlight-line">--location northeurope</span></code></pre>
<p>Ensuite nous allons créer un vNet et le subnet :</p>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">az network vnet create <span class="token punctuation">\</span></span><br><span class="highlight-line">--name vnet-test-az <span class="token punctuation">\</span></span><br><span class="highlight-line">--resource-group RG-Vnet-Exo-AZ <span class="token punctuation">\</span></span><br><span class="highlight-line">--location northeurope <span class="token punctuation">\</span></span><br><span class="highlight-line">--address-prefixes <span class="token number">10.0</span>.1.0/24 <span class="token punctuation">\</span></span><br><span class="highlight-line">--subnet-name azfrontend <span class="token punctuation">\</span></span><br><span class="highlight-line">--subnet-prefixes <span class="token number">10.0</span>.1.0/26</span></code></pre>
<h2 id="arm-template">ARM Template <a class="direct-link" href="#arm-template"> </a></h2>
<p>Pour commencer, utilisez un éditeur de texte un peu évolue, le JSON sans outil, ca pique un peu...<br>
Je vous recommande Visual Studio Code, avec ce petit article : <a href="https://etienne.deneuve.xyz/2017/01/26/visual-studio-code-pour-ansible-terraform/">sur mon blog</a><br>
Un Template Json simple contient plusieurs parties : &quot;variables&quot;, &quot;parameters&quot;, &quot;resources&quot; et &quot;outputs&quot;. Sans réexpliquer l'ensemble, voici à quoi notre Template va ressembler :</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token property">"$schema"</span><span class="token operator">:</span> <span class="token string">"&lt;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#> "</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"contentVersion"</span><span class="token operator">:</span> <span class="token string">"1.0.0.0"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token property">"vnetname"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Vnet"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"vnet-test-json"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"vnetname"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Vnet"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"vnet-test-json"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"addressSpacePrefix"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"IP v4 (RFC1918)"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"10.0.2.0/24"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"subnetName"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Subnet"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"jsonfrontend"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"subnetPrefix"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"IP v4 du Subnet"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"10.0.2.0/26"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"variables"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"2015-06-15"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Microsoft.Network/virtualNetworks"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"[parameters('VnetName')]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"[resourceGroup().location]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"JSON-VNET"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"addressSpace"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          <span class="token property">"addressPrefixes"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">            <span class="token string">"[parameters('addressSpacePrefix')]"</span></span><br><span class="highlight-line">          <span class="token punctuation">]</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"subnets"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">          <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"[parameters('subnetName')]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">              <span class="token property">"addressPrefix"</span><span class="token operator">:</span> <span class="token string">"[parameters('subnetPrefix')]"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">          <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">]</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"outputs"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Ensuite pour déployer ce fichier soit via le portail avec<br>
<a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-deploy-portal">la doc ici</a><br>
ou alors via Powershell et Azure CLI 2.0 :</p>
<h3 id="deploy-arm-using-powershell">Deploy ARM using Powershell <a class="direct-link" href="#deploy-arm-using-powershell"> </a></h3>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">New<span class="token operator">-</span>AzureRmResourceGroup <span class="token operator">-</span>Name RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span>JSON `</span><br><span class="highlight-line">   <span class="token operator">-</span>Location <span class="token string">" North Europe"</span></span><br><span class="highlight-line">New<span class="token operator">-</span>AzureRmResourceGroupDeployment <span class="token operator">-</span>Name RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span>JSON `</span><br><span class="highlight-line">   <span class="token operator">-</span>ResourceGroupName ExampleResourceGroup `</span><br><span class="highlight-line">   <span class="token operator">-</span>TemplateFile c:\MyTemplates\vnet<span class="token operator">-</span>simple<span class="token punctuation">.</span>json</span></code></pre>
<h3 id="deploy-arm-using-azure-cli-2.0">Deploy ARM using Azure CLI 2.0 <a class="direct-link" href="#deploy-arm-using-azure-cli-2.0"> </a></h3>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">az group create --name RG-XXX --location "North Europe“</span><br><span class="highlight-line">az group deployment create <span class="token punctuation">\</span></span><br><span class="highlight-line">--name ExampleDeployment <span class="token punctuation">\</span></span><br><span class="highlight-line">--resource-group ExampleGroup <span class="token punctuation">\</span></span><br><span class="highlight-line">--template-file vnet-simple.json</span></code></pre>
<h1 id="vnet-peering">vNet Peering <a class="direct-link" href="#vnet-peering"> </a></h1>
<p>L'objectif est de connecter nos 3 Vnets, avec nos 3 outils :</p>
<ul>
<li>vnet-test-ps</li>
<li>vnet-test-az</li>
<li>vnet-test-json</li>
</ul>
<h2 id="powershell-2">Powershell <a class="direct-link" href="#powershell-2"> </a></h2>
<p>Nous allons créer le lien entre vnet-test-ps et vnet-test-az :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">    <span class="token variable">$vnetPS</span> = Get<span class="token operator">-</span>AzureRmVirtualNetwork <span class="token operator">-</span>ResourceGroupName RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span><span class="token function">PS</span> <span class="token operator">-</span>Name vnet<span class="token operator">-</span>test<span class="token operator">-</span><span class="token function">ps</span></span><br><span class="highlight-line">    <span class="token variable">$vnetAZ</span> = Get<span class="token operator">-</span>AzureRmVirtualNetwork <span class="token operator">-</span>ResourceGroupName RG<span class="token operator">-</span>Vnet<span class="token operator">-</span>Exo<span class="token operator">-</span>AZ <span class="token operator">-</span>Name vnet<span class="token operator">-</span>test<span class="token operator">-</span>az</span></code></pre>
<p>Puis nous créons le lien PS2AZ :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">    Add<span class="token operator">-</span>AzureRmVirtualNetworkPeering <span class="token operator">-</span>Name PS2AZ <span class="token operator">-</span>VirtualNetwork <span class="token variable">$vnetPS</span> <span class="token operator">-</span>RemoteVirtualNetworkId <span class="token variable">$vnetAZ</span><span class="token punctuation">.</span>Id</span><br><span class="highlight-line"></span><br><span class="highlight-line">    Add<span class="token operator">-</span>AzureRmVirtualNetworkPeering <span class="token operator">-</span>Name AZ2PS <span class="token operator">-</span>VirtualNetwork <span class="token variable">$vnetAZ</span> <span class="token operator">-</span>RemoteVirtualNetworkId <span class="token variable">$vnetPS</span><span class="token punctuation">.</span>Id</span></code></pre>
<p>nous pouvons vérifié si le peering est fonctionnel via la commande Powershell :</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">     Get<span class="token operator">-</span>AzureRmVirtualNetworkPeering <span class="token operator">-</span>VirtualNetworkName vnetPS <span class="token operator">-</span>ResourceGroupName vnetPS <span class="token operator">-</span>Name PS2AZ</span></code></pre>
<p>en l'état, notre peering est configuré mais certaines options ne sont pas activées :</p>
<ul>
<li>Forwarded Traffic</li>
<li>Gateway Transit</li>
<li>Remote Gateways</li>
</ul>
<p>Dans notre cas, nous avons besoin d'activer le transfert du trafic.</p>
<pre class="language-powershell"><code class="language-powershell"><span class="highlight-line">    <span class="token variable">$ps2az</span> = Get<span class="token operator">-</span>AzureRmVirtualNetworkPeering <span class="token operator">-</span>VirtualNetworkName vnetPS <span class="token operator">-</span>ResourceGroupName vnetPS <span class="token operator">-</span>Name PS2AZ</span><br><span class="highlight-line">    <span class="token variable">$ps2az</span><span class="token punctuation">.</span>AllowForwardedTraffic = <span class="token boolean">$true</span></span><br><span class="highlight-line">    <span class="token function">Set</span><span class="token operator">-</span>AzureRmVirtualNetworkPeering <span class="token operator">-</span>VirtualNetworkPeering <span class="token variable">$ps2az</span></span></code></pre>
<h2 id="azure-cli-2.0-2">Azure CLI 2.0 <a class="direct-link" href="#azure-cli-2.0-2"> </a></h2>
<p>Avec Azure CLI, il faudra recupéré l'id du réseau distant pour le peering avec la commande :</p>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">    az network vnet list -g RG-Vnet-Exo-JSON</span></code></pre>
<p>et vous recuperez un objets json, cherchez votre id qui sera du type : <code>/subscriptions/VOTREIDDESOUSCRPTION/resourceGroups/RG-Vnet-Exo-JSON/providers/Microsoft.Network/virtualNetworks/vnet-test-json</code> Si vous utilisez le bash (Ubuntu on Windows par exemple) créer une variable comme ceci :</p>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">    <span class="token assign-left variable">JSON_VNET_ID</span><span class="token operator">=</span><span class="token string">"/subscriptions/VOTREIDDESOUSCRPTION/resourceGroups/RG-Vnet-Exo-JSON/providers/Microsoft.Network/virtualNetworks/vnet-test-json"</span></span></code></pre>
<p>Ce sera beaucoup plus simple pour l'appeler dans la commande suivante :</p>
<pre class="language-shell"><code class="language-shell"><span class="highlight-line">az network vnet peering create --name AZ2JSON <span class="token punctuation">\</span></span><br><span class="highlight-line">  --remote-vnet-id <span class="token variable">${$JSON_VNET_ID}</span> <span class="token punctuation">\</span></span><br><span class="highlight-line">  --resource-group RG-Vnet-Exo-AZ <span class="token punctuation">\</span></span><br><span class="highlight-line">  --vnet-name vnet-test-az <span class="token punctuation">\</span></span><br><span class="highlight-line">  --allow-forwarded-traffic <span class="token punctuation">\</span></span><br><span class="highlight-line">  --allow-vnet-access <span class="token punctuation">\</span></span></code></pre>
<p>Théoriquement, nous pourrions executer la commande pour effectuer le peering dans l'autre sens, mais nous allons la faire avec notre template de la partie 1.</p>
<h2 id="arm-template-2">ARM Template <a class="direct-link" href="#arm-template-2"> </a></h2>
<p>Pour déclarer un vnet peering dans un template ARM, à l'heure actuelle, via le portail ou la ligne de commande (Powershell ou Azure CLI 2.0) il n'est pas possible dans le &quot;contexte&quot; de manipuler deux Resource Group. Du coup, il faut le faire d'un coté puis de l'autre, ou utiliser des templates &quot;nested&quot; c'est à dire un template &quot;parent&quot; puis deux &quot;enfants&quot;. Nous n'allons (pas encore ;)) aborder ce type de template. (Stay Tuned !) Donc, reprenons notre template et ajoutons un nouveau type de resource Azure <code>&quot;Microsoft.Network/virtualNetworks/virtualNetworkPeerings&quot;</code></p>
<pre class="language-json"><code class="language-json"><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token property">"$schema"</span><span class="token operator">:</span> <span class="token string">"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"contentVersion"</span><span class="token operator">:</span> <span class="token string">"1.0.0.0"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"vnetname"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Vnet"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"vnet-test-json"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"vNetRemote"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Vnet distant"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"vnet-test-az"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"RGvNetRemote"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Resource Group"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"RG-Vnet-Exo-AZ"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"addressSpacePrefix"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"IP v4 (RFC1918)"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"10.0.2.0/24"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"subnetName"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Nom du Subnet"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"jsonfrontend"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token property">"subnetPrefix"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"IP v4 du Subnet"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"defaultValue"</span><span class="token operator">:</span> <span class="token string">"10.0.2.0/26"</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"variables"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">        <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"2015-06-15"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Microsoft.Network/virtualNetworks"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"[parameters('VnetName')]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"[resourceGroup().location]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"JSON-VNET"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"addressSpace"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                    <span class="token property">"addressPrefixes"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">                        <span class="token string">"[parameters('addressSpacePrefix')]"</span></span><br><span class="highlight-line">                    <span class="token punctuation">]</span></span><br><span class="highlight-line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token property">"subnets"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">                    <span class="token punctuation">{</span></span><br><span class="highlight-line">                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"[parameters('subnetName')]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                            <span class="token property">"addressPrefix"</span><span class="token operator">:</span> <span class="token string">"[parameters('subnetPrefix')]"</span></span><br><span class="highlight-line">                        <span class="token punctuation">}</span></span><br><span class="highlight-line">                    <span class="token punctuation">}</span></span><br><span class="highlight-line">                <span class="token punctuation">]</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"2017-03-01"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Microsoft.Network/virtualNetworks/virtualNetworkPeerings"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"[concact( parameters('VnetName') , '/JSON2AZ')]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"[resourceGroup().location]"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token property">"allowVirtualNetworkAccess"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token property">"allowForwardedTraffic"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token property">"allowGatewayTransit"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token property">"useRemoteGateways"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token property">"remoteVirtualNetwork"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"[resourceId( subscription().subscriptionid, parameters('RGvNetRemote') , 'Microsoft.Network/virtualNetworks', parameters('vNetRemote'))]"</span></span><br><span class="highlight-line">                <span class="token punctuation">}</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"outputs"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>La méthode de déploiement reste la même que dans la partie 1.</p>

    </main>
    <aside class="aside aside-supplemental d-none d-lg-block col-lg-2 col-xl-2">
      <span class="meta__stats">About 4 min reading time</span>
      <nav class="sticky-top">
        <div class="">
                <ol>
                    
                    <li><a href="#powershell">Powershell  </a>
            		</li>

                    <li><a href="#azure-cli-2.0">Azure CLI 2.0  </a>
            		</li>

                    <li><a href="#arm-template">ARM Template  </a>
            
                <ol>
                    
                    <li><a href="#deploy-arm-using-powershell">Deploy ARM using Powershell  </a>
            		</li>

                    <li><a href="#deploy-arm-using-azure-cli-2.0">Deploy ARM using Azure CLI 2.0  </a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#powershell-2">Powershell  </a>
            		</li>

                    <li><a href="#azure-cli-2.0-2">Azure CLI 2.0  </a>
            		</li>

                    <li><a href="#arm-template-2">ARM Template  </a>
            		</li>
                </ol>
            </div>
      </nav>
    </aside>
  </div>
</div>
</div>
    <footer class="site-footer bg-transparent pb-3 pb-md-5">
      <div class="layout-social container d-flex justify-content-center">

  

  

  

  

  

  

  

</div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
    <script>
      window
        .cookieconsent
        .initialise({
          "palette": {
            "popup": {
              "background": "#3937a3"
            },
            "button": {
              "background": "transparent",
              "text": "#e62576",
              "border": "#e62576"
            }
          },
          "position": "bottom-right",
          "content": {
            "href": "/privacy/"
          }
        });
    </script>
  </body>

</html>