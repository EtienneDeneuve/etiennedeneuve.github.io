<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    

    <title>XYZ Blog</title>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
    

    <script src="/js/script.js"></script>
    </head>
  <body class="position-relative" data-spy="scroll" data-target=".site-nav" data-offset="55">
    <nav class="site-nav family-sans navbar navbar-expand-md navbar-dark  sidebar sticky-top  py-0">
  <div class="container-fluid">
    <button type="button" class="navbar-toggler my-2 my-md-0" data-toggle="collapse" data-target="#myTogglerNav" aria-controls="myTogglerNav" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="navbar-brand text-uppercase">
      <a class="text-light" href="/"><i class="fas fa-cube mr-2"></i>XYZ Blog</a> 
    </div>

    <div class="collapse navbar-collapse text-center mt-0" id="myTogglerNav">
      <div class="navbar-nav ml-auto font-weight-regular text-uppercase">
        
        <a class="d-none nav-item nav-link" href="#page-hero">hero target</a>
        <a class="d-none nav-item nav-link" href="#main-content">nav target</a>
        
        <a class="nav-item nav-link font-weight-bold  text-light" href="/"><i class="fas fa-home"></i></a>
        
          <a class="nav-item nav-link" href="/courses/0/">courses</a>
          
          <a class="nav-item nav-link" href="/posts/0/">posts</a>
          <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Projects
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">




          </div>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item text-capitalize" href="/about">About Me</a>
            <div class="dropdown-divider"></div><a class="dropdown-item text-capitalize" target="_blank" href="https://github.com/etiennedeneuve">
            <i class="fab fa-github text-secondary mr-2"></i>github
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://linkedin.com/in/etiennedeneuve">
            <i class="fab fa-linkedin text-secondary mr-2"></i>linkedin
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://twitter.com/etiennedinfo">
            <i class="fab fa-twitter text-secondary mr-2"></i>twitter
          </a></div>
        </div>
      </div>
      <div class="searchbox pl-2 py-2">
    <input
      type="text"
      v-model="query"
      class="form-control text-white border m-auto"
      :class="[isActive ? 'wide' : 'short']"
      @focus="isActive=true"
      @blur.prevent="handleBlur"
      ref="searchinput"
      style="background: transparent;"
      aria-describedby="searchinput"
      autocomplete="off"
    >
    <div v-if="query && isActive" class="position-absolute justify-content-center" style="top: 47px;">
      <div class="card bg-secondary">
        <ul class="list-group list-group-flush px-0" v-for="(item, index) in queried" :key="index">
          <li class="list-group-item">
            <a :href="item.url" class="d-flex text-secondary">
              <span class="pr-2" v-html="item.icon"></span>
              <span class="text-body text-left" v-html="item.title"></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
</div>
    </div>
  </div>
</nav>

      

 
  <div class="post post-sidebar container-fluid">
    <div class="row justify-content-xl-center">
      <main class="main col">
      <h1 id="terraform">Terraform <a class="direct-link" href="#terraform"> </a></h1>
<h2 id="avant-de-%22coder%22">Avant de &quot;coder&quot; <a class="direct-link" href="#avant-de-%22coder%22"> </a></h2>
<p>Je ne vous présente pas à nouveau Terraform, je l'ai déjà fait <a href="https://etienne.deneuve.xyz/2017/10/01/microsoft-experience-17-infrastructure-code-modelisez-et-provisionnez-vos-services-azure-avec-terraform-et-packer/">ici</a>, <a href="https://stanislas.io/2017/01/24/infrastructure-dans-azure-c-est-comme-du-lego-slides-et-ressources-utiles/">ici</a> ou sinon sur mon <a href="https://github.com/etiennedeneuve/Azure/tree/master/Terraform">github</a>. Je vous invite également à regarder la <a href="https://stanislas.io/2017/09/18/video-infrastructure-as-code-dans-azure-avec-terraform/">vidéo</a> de Stanislas Quastana.<br>
Si vous êtes des partenaires Microsoft, vous pouvez (devez) suivre les webinars <a href="http://aka.ms/azure-lab">Azure Lab Experiences</a> de <a href="https://www.linkedin.com/in/oseborn/">Mickael Debois</a> et de <a href="https://www.linkedin.com/in/florent-chambon/">Florent Chambon</a>.<br>
L'objet de cet article est de vous montrer quelques points intéressants qu'il est bon de connaître !</p>
<h2 id="providers">Providers <a class="direct-link" href="#providers"> </a></h2>
<p>Terraform repose sur des providers que nous pouvons déclarer tel que :</p>
<pre><code>provider &amp;quot;nomduprovider&amp;quot; {

}
</code></pre>
<p>J'en ai trouvé qui sont plutôt sympas  fournis par Hashicorp:</p>
<ul>
<li><a href="https://www.terraform.io/docs/providers/random/index.html">Random</a></li>
<li><a href="https://www.terraform.io/docs/providers/template/index.html">Template</a></li>
</ul>
<p>ou encore ceux de la communauté que je ne détaillerai pas, mais à  noter la présence d'un provider Active Directory, Google Calendar, Let's encrypt... la liste complète <a href="https://www.terraform.io/docs/providers/type/community-index.html">ici</a>.</p>
<h3 id="random">Random <a class="direct-link" href="#random"> </a></h3>
<p>Voici un exemple pour le provider random :</p>
<pre><code>provider &amp;quot;random&amp;quot; {}

resource &amp;quot;random_pet&amp;quot; &amp;quot;demo_pet&amp;quot; {
prefix = &amp;quot;myad&amp;quot;
separator = &amp;quot;.&amp;quot;
}

resource &amp;quot;random_id&amp;quot; &amp;quot;demo_id&amp;quot; {
prefix = &amp;quot;web&amp;quot;
byte_length = 8
}

output &amp;quot;demo&amp;quot; {
value = &amp;quot;${random_pet.demo_pet.id}&amp;quot;
}

output &amp;quot;demo-id&amp;quot; {
value = &amp;quot;${random_id.demo_id.dec}&amp;quot;
}
</code></pre>
<p>Recopiez cet exemple puis exécutez la commande <code>terraform init</code> :</p>
<pre><code>PS C:\Users\etien\Documents\it\blog&amp;gt; terraform init

Initializing provider plugins...
- Checking for available provider plugins on https://releases.hashicorp.com...
- Downloading plugin for provider &quot;random&quot; (1.2.0)...

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = &quot;...&quot; constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.random: version = &quot;~&amp;gt; 1.2&quot;

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
</code></pre>
<p>Une fois que l'init est fait, nous sommes prêts ! lancez donc <code>terraform apply</code> :</p>
<pre><code>PS C:\Users\etien\Documents\it\blog&amp;gt; terraform apply

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
+ create

Terraform will perform the following actions:

+ random_id.demo_id
id:
b64:
b64_std:
b64_url:
byte_length: &amp;quot;8&amp;quot;
dec:
hex:
prefix: &amp;quot;web&amp;quot;

+ random_pet.demo_pet
id:
length: &amp;quot;2&amp;quot;
prefix: &amp;quot;myad&amp;quot;
separator: &amp;quot;.&amp;quot;

Plan: 2 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
Terraform will perform the actions described above.
Only &amp;#039;yes&amp;#039; will be accepted to approve.

Enter a value: yes

random_pet.demo_pet: Creating...
length: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;2&amp;quot;
prefix: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;myad&amp;quot;
separator: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;.&amp;quot;
random_id.demo_id: Creating...
b64: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;&amp;quot;
b64_std: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;&amp;quot;
b64_url: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;&amp;quot;
byte_length: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;8&amp;quot;
dec: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;&amp;quot;
hex: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;&amp;quot;
prefix: &amp;quot;&amp;quot; =&amp;gt; &amp;quot;web&amp;quot;
random_pet.demo_pet: Creation complete after 0s (ID: myad.quiet.filly)
random_id.demo_id: Creation complete after 0s (ID: aZLeiFCrOno)

Apply complete! Resources: 2 added, 0 changed, 0 destroyed.

Outputs:

demo = myad.quiet.filly
demo-id = web7607387397632506490
</code></pre>
<p>Voilà, grâce à ce provider, plus besoin de chercher des noms pour vos tests et vos déploiments de cattle !</p>
<h3 id="template">Template <a class="direct-link" href="#template"> </a></h3>
<p>Pour le provider template, reprenez votre fichier et ajoutez les éléments suivants :</p>
<pre><code>provider &amp;quot;random&amp;quot; {}

resource &amp;quot;random_pet&amp;quot; &amp;quot;demo_pet&amp;quot; {
prefix = &amp;quot;myad&amp;quot;
separator = &amp;quot;.&amp;quot;
}

resource &amp;quot;random_id&amp;quot; &amp;quot;demo_id&amp;quot; {
prefix = &amp;quot;web&amp;quot;
byte_length = 4
}

output &amp;quot;demo&amp;quot; {
value = &amp;quot;${random_pet.demo_pet.id}&amp;quot;
}

output &amp;quot;demo-id&amp;quot; {
value = &amp;quot;${random_id.demo_id.dec}&amp;quot;
}

provider &amp;quot;template&amp;quot; {}

data &amp;quot;template_file&amp;quot; &amp;quot;demo&amp;quot; {
template = &amp;lt;&amp;lt;-EOF #/bin/shell hostname $${hostname} EOF vars { hostname = &amp;quot;${random_pet.demo_pet.id}&amp;quot; } } output &amp;quot;demo-template&amp;quot; { value = &amp;quot;${data.template_file.demo.*.rendered}&amp;quot; } ``` puis faites votre init, comme nous avons un nouveau provider, puis votre apply : ``` PS C:\Users\etien\Documents\it\blog&amp;gt; terraform apply
random_pet.demo_pet: Refreshing state... (ID: myad.quiet.filly)
random_id.demo_id: Refreshing state... (ID: ksLYNA)
data.template_file.demo: Refreshing state...

Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

Outputs:

demo = myad.quiet.filly
demo-id = web2462242868
demo-template = [
#/bin/shell

hostname myad.quiet.filly

]
</code></pre>
<p>Ce provider est assez pratique pour générer des user_data ou des scripts customisés à chaque lancement en fonction des variables du contexte.</p>
<h2 id="datasources">DataSources <a class="direct-link" href="#datasources"> </a></h2>
<p>Comme nous venons de le voir, à moins d'avoir fait un copier coller sans lire le code, dans Terraform nous avions plusieurs type dont &quot;provider&quot;, &quot;resource&quot; ou encore &quot;output&quot; et &quot;variable&quot;, mais aussi &quot;data&quot;. Ce type est assez intéressant puisqu'il permet d'interroger dynamiquement le provider.<br>
Admettons, vous avez une belle infra réseau dans Azure et vous souhaitez ajouter une belle machine dans ce beau réseau, avant ce n'était pas super pratique, il fallait jouer avec les imports, au risque de supprimer le vnet (par erreur, un vendredi soir vers 17h, au hazard) lors de l'invocation de la meilleure commande de terraform (destroy).</p>
<p>Voici un petit exemple de l'utilisation de ces datasources :</p>
<pre><code>provider &quot;azurerm&quot; {

}

data &quot;azurerm_virtual_network&quot; &quot;test&quot; {
name = &quot;production&quot;
resource_group_name = &quot;networking&quot;
}

output &quot;virtual_network_id&quot; {
value = &quot;${data.azurerm_virtual_network.test.id}&quot;
}
</code></pre>
<p>&gt; Vous noterez surement que mon provider azurerm est vide, non je n'ai pas effacé mes infos, mais je vais vous donner deux solutions pour ne pas les oublier avant de faire un commit sur un github public avec votre SPN en clair pour tous.<br>
&gt;<br>
&gt; - Solution 1 :<br>
&gt; Installez Azure Cli 2.0<br>
&gt; - Solution 2 :<br>
&gt; Ajouter a vos variables d'environnement les elements :<br>
&gt;<br>
&gt; * ARM_SUBSCRIPTION_ID,<br>
&gt; * ARM_CLIENT_ID,<br>
&gt; * ARM_CLIENT_SECRET,<br>
&gt; * ARM_TENANT_ID<br>
&gt;<br>
&gt;Si vous utilisez Powershell, n'oubliez pas que vous pouvez les créer de cette façon :<br>
&gt;<code>&amp;gt;Set-Item env:\ARM_SUBSCRIPTION_ID -Value votrevalue &amp;gt;</code></p>
<h1 id="pour-conclure">Pour conclure <a class="direct-link" href="#pour-conclure"> </a></h1>
<p>J'èspere que ça vous sera utile :)</p>
<p>Si vous souhaitez en savoir plus, je présente une session au Global Azure Bootcamp le 21 avril à l'école 42 répondant au titre de : &quot;(Terraform + Packer + Ansible) + Azure = &lt;3 ?&quot;</p>

      </main>
      <aside class="aside aside-supplemental d-none d-lg-block col-lg-2 col-xl-2" >
        <nav class="sticky-top">
        <div class="">
                <ol>
                    
                    <li><a href="#avant-de-%22coder%22">Avant de "coder"  </a>
            		</li>

                    <li><a href="#providers">Providers  </a>
            
                <ol>
                    
                    <li><a href="#random">Random  </a>
            		</li>

                    <li><a href="#template">Template  </a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#datasources">DataSources  </a>
            		</li>
                </ol>
            </div>
        </nav>
      </aside>
    </div>
  </div>
</div>

    <footer class="site-footer bg-transparent pb-3 pb-md-5">
      <div class="layout-social container d-flex justify-content-center">

  

  

  

  

  

  

  

</div>
    </footer>
  </body>

</html>