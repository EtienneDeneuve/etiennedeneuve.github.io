<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="msvalidate.01" content="DE6C71A9BE4E011D01CC38799992B4A6"/>
    
      <link rel="stylesheet" href="/css/style.css" type="text/css">
    

    <title>XYZ Blog</title>
    <script defer="defer" src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
    

    <script src="/js/script.js"></script>
  </head>
  <body class="position-relative" data-spy="scroll" data-target=".site-nav" data-offset="55">
    <nav class="site-nav family-sans navbar navbar-expand-md navbar-dark  sidebar sticky-top  py-0">
  <div class="container-fluid">
    <button type="button" class="navbar-toggler my-2 my-md-0" data-toggle="collapse" data-target="#myTogglerNav" aria-controls="myTogglerNav" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="navbar-brand text-uppercase">
      <a class="text-light" href="/"><i class="fas fa-cube mr-2"></i>XYZ Blog</a> 
    </div>

    <div class="collapse navbar-collapse text-center mt-0" id="myTogglerNav">
      <div class="navbar-nav ml-auto font-weight-regular text-uppercase">
        
        <a class="d-none nav-item nav-link" href="#page-hero">hero target</a>
        <a class="d-none nav-item nav-link" href="#main-content">nav target</a>
        
        <a class="nav-item nav-link font-weight-bold  text-light" href="/"><i class="fas fa-home"></i></a>
        
          <a class="nav-item nav-link" href="/posts/0/">posts</a>
          
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item text-capitalize" href="/about">About Me</a>
            <div class="dropdown-divider"></div><a class="dropdown-item text-capitalize" target="_blank" href="https://github.com/etiennedeneuve">
            <i class="fab fa-github text-secondary mr-2"></i>github
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://linkedin.com/in/etiennedeneuve">
            <i class="fab fa-linkedin text-secondary mr-2"></i>linkedin
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://twitter.com/etiennedinfo">
            <i class="fab fa-twitter text-secondary mr-2"></i>twitter
          </a></div>
        </div>
      </div>
      <div class="searchbox pl-2 py-2">
    <input
      type="text"
      v-model="query"
      class="form-control text-white border m-auto"
      :class="[isActive ? 'wide' : 'short']"
      @focus="isActive=true"
      @blur.prevent="handleBlur"
      ref="searchinput"
      style="background: transparent;"
      aria-describedby="searchinput"
      autocomplete="on"
    >
    <div v-if="query && isActive" class="position-absolute justify-content-center" style="top: 47px;">
      <div class="card bg-secondary">
        <ul class="list-group list-group-flush px-0" v-for="(item, index) in queried" :key="index">
          <li class="list-group-item">
            <a :href="item.url" class="d-flex text-secondary">
              <span class="pr-2" v-html="item.icon"></span>
              <span class="text-body text-left" v-html="item.title"></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
</div>
    </div>
  </div>
</nav>

    



<div class="post post-sidebar container-fluid">
  <div class="row justify-content-xl-center">
    

    
    <main class="main col">
      

      <h2>Le constat</h2>
Bien souvent, dans l'Infra as Code, la documentation est assez sommaire, trop manuelle et donc par conséquents obsolète, une heure après l'avoir terminée ( et puis globalement, c'est ch*** non ?).
<!--more-->
<p>Si vous n'avez pas encore lu les articles suivants :</p>
<ul>
<li><a href="https://etienne.deneuve.xyz/2018/06/23/git-pour-ops-par-un-ops/"><a href="">Git for ops</a></a></li>
<li><a href="https://etienne.deneuve.xyz/2018/06/26/setup-vs-code-bash-git/"><a href="">Mon Setup de VS Code pour Bash et Git</a></a></li>
<li><a href="https://etienne.deneuve.xyz/2017/10/01/microsoft-experience-17-infrastructure-code-modelisez-et-provisionnez-vos-services-azure-avec-terraform-et-packer/"><a href="">Terraform</a></a></li>
<li><a href="https://etienne.deneuve.xyz/2017/10/09/vsts-for-ops-1/"><a href="">Visual Studio Code</a></a></li>
</ul>
<p>Je vous invite à le faire, ils sont en quelques sortes des pré-requis, si vous ne connaissez pas encore git, VS Code ou encore Terraform.</p>
<h2 id="%22ma%22-solution">&quot;Ma&quot; solution <a class="direct-link" href="#%22ma%22-solution"> </a></h2>
<p>J'utilise des outils comme ansible-docgen ou terraform-docs, ou encore PlatyPS pour générer mes documentations automatiquement, et ce a chaque commit. Ces outils vont parser le code Ansible, Terraform ou Powershell (et il en existe surement pleins d'autres!). Ainsi je suis sûr que ma documentation reflete bien l'etat actuel de mon code, et non pas une version antidaté, mise à jour une fois tout les 6 mois.</p>
<h3 id="pr%C3%A9paration">Préparation <a class="direct-link" href="#pr%C3%A9paration"> </a></h3>
<p>Comme dans l'article <a href="https://etienne.deneuve.xyz/2018/06/26/setup-vs-code-bash-git/" target="_blank" rel="noopener">Open Source + Windows = VS Code + Bash + Git</a>, installez les binaires suivants dans votre bash :</p>
<p>Packages à installer sur le bash Windows :</p>
<pre><code>#!/bin/bash

#(obligatoire)installation de git, wget, unzip, python et curl
sudo apt install git wget unzip python curl

# (obligatoire) recuperation du gestionnaire de package &amp;quot;pip&amp;quot;
wget https://bootstrap.pypa.io/get-pip.py

# (optionnel) recuperation de terraform
wget https://releases.hashicorp.com/terraform/0.11.7/terraform_0.11.7_linux_amd64.zip -O terraform.zip

# (obligatoire pour la génération des docs de terraform)
wget https://github.com/segmentio/terraform-docs/releases/download/v0.3.0/terraform-docs_linux_amd64 -O terraform-docs

# (optionnel) extraction de terraform

unzip terraform.zip

# (optionnel) déplacement de terraform dans bin

mv terraform /home/${USER}/.local/bin/

# (obligatoire pour la génération des docs de terraform) déplacement de terraform-docs dans bin

mv terraform-docs /home/${USER}/.local/bin/

# (Obligatoire) installation de pip
python get-pip.py --user

# Correction du path si necessaire pour l&amp;#039;execution de terraform et terraform docs
if [[ &amp;quot;:$PATH:&amp;quot; == *&amp;quot;:$HOME/.local/bin&amp;quot;* ]]; then
echo &amp;quot;Your path is correctly set&amp;quot;
else
PATH=$PATH:/home/${USER}/.local/bin
export PATH
fi

# (obligatoire) upgrade de pip
pip install pip --upgrade --user

# (obligatoire pour ansible) installation de ansible-lint ansible-docgen ansible avec les module azure et pywirm
pip install ansible-lint ansible-docgen ansible[azure] pywinrm --user
# (obligatoire) installation de pre-commit
pip install pre-commit
</code></pre>
<p>Récupérer le script de génération d'un sommaire dans notre future doc (toujours mieux d'avoir une belle table des matière !):</p>
<pre><code>wget https://raw.githubusercontent.com/ekalinin/github-markdown-toc/master/gh-md-toc -O ./gh-md-toc
mv ./gh-md-toc /home/${USER}/.local/bin
chmod +x /home/${USER}/.local/bin/gh-md-toc
</code></pre>
<p>Récupérer le fichier <code>.pre-commit-config.yaml</code> dans ce même article ou sur mon <a href="https://raw.githubusercontent.com/EtienneDeneuve/vsts-for-ops/master/.pre-commit-config.yaml">GitHub</a> :</p>
<pre><code>cat &amp;lt;.&amp;gt;&amp;lt;/.&amp;gt;---
repos:
- repo: https://github.com/pre-commit/pre-commit-hooks
rev: v1.3.0
hooks:
- id: trailing-whitespace
- id: check-yaml
- id: check-xml
- id: check-json
- id: end-of-file-fixer
- id: trailing-whitespace
- id: check-case-conflict
- id: check-merge-conflict
# - id: check-executables-have-shebangs
- id: check-added-large-files
- id: detect-private-key
- id: pretty-format-json
- id: sort-simple-yaml
- repo: https://github.com/willthames/ansible-lint.git
rev: v3.5.0rc1
hooks:
- id: ansible-lint
files: \.(yaml|yml)$
exclude: ./env/
- repo: git://github.com/antonbabenko/pre-commit-terraform
rev: v1.7.3
hooks:
- id: terraform_fmt
- id: terraform_docs
EOF
# puis on l&amp;#039;ajoute à l&amp;#039;index :
git add .pre-commit-config.yaml
git commit -m &amp;quot;adding pre-commit-config&amp;quot;
</code></pre>
<p>Puis, lancer l'installation avec <code>pre-commit install</code>. Ceci nous permet de bien valider nos fichiers avant les commits.</p>
<h3 id="g%C3%A9n%C3%A9ration-manuelle-de-la-documentation-pour-ansible">Génération manuelle de la documentation pour Ansible <a class="direct-link" href="#g%C3%A9n%C3%A9ration-manuelle-de-la-documentation-pour-ansible"> </a></h3>
<p>Le package <code>ansible-docgen</code> permets de générer une documentation des rôles et des playbook présents dans le dossier.</p>
<h3 id="generation-manuelle-de-la-documentation-pour-terraform">Generation manuelle de la documentation pour Terraform <a class="direct-link" href="#generation-manuelle-de-la-documentation-pour-terraform"> </a></h3>
<p>Le package &quot;terraform-docs&quot; permets de générer une documentation des roles et des playbook présents dans le dossier.</p>
<h3>Automatisation de la doc pour Ansible</h3>
Voici un script que j'utilises pour générer ma documentation Ansible :
<pre><code>#!/bin/bash
# je genere la documentation avec ansible-docget pour tout le dossier 
ansible-docgen -p .
# je créer un dossier &amp;quot;docs&amp;quot; dans le projet github
mkdir -p ./docs
# si le dossier contien déjà un fichier fullreadme.md je le déplace 
if [ -d &amp;quot;./docs/fullreadme.md&amp;quot; ]; then
mv ./docs/fullreadme.md ./docs/fullreadme-$(date +&amp;quot;%m_%d_%Y&amp;quot;).old
else
# sinon j&amp;#039;affiche un mesage
echo &amp;quot;full readme doesn&amp;#039;t exists yet&amp;quot;
fi
# j&amp;#039;ajoute le titre à mon document
echo &amp;#039;# Ansible documentation&amp;#039; &amp;gt; ./docs/fullreadme.md
# J&amp;#039;ajoute les placeholders pour injecter la table des matieres
echo &amp;#039;&amp;lt;!--ts--&amp;gt;&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
echo &amp;#039;&amp;lt;!--te--&amp;gt;&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# J&amp;#039;ajoute un titre intermédiaire 
echo &amp;#039;## Roles et Playbook Ansible&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# Je créer une section pour les playbooks
echo &amp;#039;### Playbook&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# et j&amp;#039;ajoute le contenu du readme.md générer par ansible-docgen (ce sont les playbooks)
# l&amp;#039;expression sed permet de promouvoir les titres sur un niveau plus haut (# vers ##)
cat ./README.md| sed &amp;#039;/^#/s/^/##/&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# je créer maintenant la section pour les roles
echo &amp;#039;### Roles&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# et j&amp;#039;ajoute le contenu
# l&amp;#039;expression sed permet de promouvoir les titres sur un niveau plus haut (# vers ##)
cat ./roles/README.md| sed &amp;#039;/^#/s/^/##/&amp;#039; &amp;gt;&amp;gt; ./docs/fullreadme.md
# Je génère la table des matières et je l&amp;#039;injecte 
gh-md-toc --insert ./docs/fullreadme.md
# je pousse mon fullreadme.md vers readme.md pour qu&amp;#039;il soit afficher par defaut dans GitHub ou vsts
cp ./docs/fullreadme.md ./README.md
</code></pre>
<h3>Automatisation de la doc pour Terraform</h3>
<span style="display: inline !important; float: none; background-color: transparent; color: #555555; cursor: text; font-family: 'Lato','Helvetica Neue',Arial,sans-serif; font-size: 18px; font-style: normal; font-variant: normal; font-weight: 300; letter-spacing: normal; orphans: 2; text-align: left; text-decoration: none; text-indent: 0px; text-transform: none; -webkit-text-stroke-width: 0px; white-space: normal; word-spacing: 0px;">Voici un script que j'utilises pour générer ma documentation Terraform:</span>
<pre><code>#!/bin/bash
# conservation de l&amp;#039;ancien readme (backup)
mv ./README.md ./README.old
# recherche de tout les repertoires et execution de terraform-docs dans chacun d&amp;#039;eux
find . -type d -exec bash -c &amp;#039;terraform-docs md &amp;quot;{}&amp;quot; &amp;gt; &amp;quot;{}&amp;quot;/README.md;&amp;#039; \;
# recherche de tout les readme.md vide et suppression
find . -name &amp;quot;README.md&amp;quot; -size 1c -type f -delete
# creation du titre du document
echo &amp;#039;# Terraform Modules Documentation&amp;#039; &amp;gt; modules.md
# ajout des placeholder pour la generation de la tables des matières
echo &amp;#039;&amp;lt;!--ts--&amp;gt;&amp;#039; &amp;gt;&amp;gt; modules.md
echo &amp;#039;&amp;lt;!--te--&amp;gt;&amp;#039; &amp;gt;&amp;gt; modules.md
# boucle sur tout les readme.md present
for f in $(find ./ -name &amp;#039;README.md&amp;#039;)
do
# ajout du nom du fichier pour la table des matieres
echo &amp;quot;## $f&amp;quot; &amp;gt;&amp;gt; modules.md
# ajout du contenu du fichier avec une expression sed pour ajouter un niveau dans l&amp;#039;arboresence
cat $f | sed &amp;#039;/^#/s/^/#/&amp;#039; &amp;gt;&amp;gt; modules.md
done
# insertion de la table des matières
gh-md-toc --insert modules.md
# copie du fichier modules.md temporaire vers README.md pour un affichage directe sur GitHub et VSTS
cp ./modules.md ./README.md
</code></pre>
<h2>Ajout de ces scripts dans Git</h2>
Afin de transformer ces scripts en "hooks" il suffit de les placer dans le repertoire caché .git/hooks.
<p>Dans mon autre article Open Source + Windows = VS Code + Bash + Git, nous avons utiliser les pré-commit hooks, cette fois-ci nous allons utiliser le post-commit</p>
<p>Ajoutez un fichier post-commit (executable) ajoutez le contenu suivant :</p>
<pre><code>
#!/bin/bash

&amp;quot;$(dirname $0)/generate_docs.sh&amp;quot;

</code></pre>
<p>puis créer un fichier &quot;generate_docs.sh&quot; avec comme contenu le script, de votre choix (Terraform ou Ansible).</p>
<p>Voila, maintenant à chaque commit réussi, la doc de votre projet sera mise à jour.</p>

    </main>
    <aside class="aside aside-supplemental d-none d-lg-block col-lg-2 col-xl-2">
      <span class="meta__stats">About 4 min reading time</span>
      <nav class="sticky-top">
        <div class="">
                <ol>
                    
                    <li><a href="#%22ma%22-solution">"Ma" solution  </a>
            
                <ol>
                    
                    <li><a href="#pr%C3%A9paration">Préparation  </a>
            		</li>

                    <li><a href="#g%C3%A9n%C3%A9ration-manuelle-de-la-documentation-pour-ansible">Génération manuelle de la documentation pour Ansible  </a>
            		</li>

                    <li><a href="#generation-manuelle-de-la-documentation-pour-terraform">Generation manuelle de la documentation pour Terraform  </a>
            		</li>
                </ol>
            		</li>
                </ol>
            </div>
      </nav>
    </aside>
  </div>
</div>
</div>
    <footer class="site-footer bg-transparent pb-3 pb-md-5">
      <div class="layout-social container d-flex justify-content-center">

  

  

  

  

  

  

  

</div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
    <script>
      window
        .cookieconsent
        .initialise({
          "palette": {
            "popup": {
              "background": "#3937a3"
            },
            "button": {
              "background": "transparent",
              "text": "#e62576",
              "border": "#e62576"
            }
          },
          "position": "bottom-right",
          "content": {
            "href": "/privacy/"
          }
        });
    </script>
  </body>

</html>