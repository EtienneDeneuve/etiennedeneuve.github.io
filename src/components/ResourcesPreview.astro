---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import Icon from "./Icon.astro";
import Pill from "./Pill.astro";
import { siteConfig } from "../config/site.ts";

interface Props {
    resource: CollectionEntry<"resources">;
}

const { resource } = Astro.props;

// Helper pour formater les dates
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
};

const lastReviewed = formatDate(resource.data.lastReviewed);
const now = new Date();
const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
const isStale = resource.data.lastReviewed.valueOf() < oneYearAgo.getTime();

// Helper pour les niveaux
const levelLabels = {
  beginner: "Débutant",
  intermediate: "Intermédiaire",
  advanced: "Avancé",
};

// Helper pour les types
const typeLabels = {
  guide: "Guide",
  link: "Lien",
  tool: "Outil",
  book: "Livre",
  podcast: "Podcast",
  video: "Vidéo",
  course: "Cours",
};
---

<a
    class="card"
    href={`/resources/${resource.slug}`}
    target="_blank"
    rel="noopener noreferrer"
>
    <span class="title">{resource.data.title}</span>
    <Image
        src={`${resource.data.img}` ||
            siteConfig.site.defaultOgImage}
        alt={resource.data.img_alt || ""}
        inferSize={true}
        loading="lazy"
        decoding="async"
    />
    <div class="details">
        <div class="flex-left">
            <div class="meta-info">
                <span class="meta-item">
                    <Icon icon="code" size="1em" />
                    {levelLabels[resource.data.level]}
                </span>
                {resource.data.timeToConsume && (
                    <span class="meta-item">
                        <Icon icon="rocket-launch" size="1em" />
                        {resource.data.timeToConsume}
                    </span>
                )}
                <span class={`meta-item ${isStale ? "stale" : ""}`}>
                    <Icon icon="rocket-launch" size="1em" />
                    Révisé: {lastReviewed}
                </span>
            </div>
        </div>
        <div class="flex-right">
            <div class="badges">
                <Pill>{typeLabels[resource.data.type]}</Pill>
                {isStale && (
                    <Pill class="stale-badge">À revoir</Pill>
                )}
            </div>
        </div>
    </div>

    <style>
        .card {
            display: grid;
            grid-template: auto 1fr / auto 1fr;
            height: 11rem;
            background: var(--gradient-subtle);
            border: 1px solid var(--gray-800);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            text-decoration: none;
            font-family: var(--font-brand);
            font-size: var(--text-lg);
            font-weight: 500;
            transition: box-shadow var(--theme-transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .title {
            grid-area: 1 / 1 / 2 / 2;
            z-index: 1;
            margin: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-999);
            color: var(--gray-200);
            border-radius: 0.375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .details {
            grid-area: 4 / 1 / 4 / 4;
            font-size: small;
            display: flex;
            flex-flow: row wrap;
            z-index: 1;
            padding: 0.5rem 1rem;
            background: var(--gray-999);
            color: var(--gray-200);
            border-radius: 0.375rem;
            justify-content: space-between;
        }
        .flex-right {
            text-align: left;
            align-self: flex-start;
        }
        .flex-left {
            align-self: flex-end;
        }

        .meta-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--text-xs);
            color: var(--gray-400);
        }

        .meta-item.stale {
            color: var(--accent-regular);
            font-weight: 600;
        }

        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .stale-badge {
            background-color: var(--accent-regular);
            border-color: var(--accent-regular);
        }
        img {
            grid-area: 1 / 1 / 3 / 3;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @media (min-width: 50em) {
            .card {
                height: 22rem;
                border-radius: 1.5rem;
            }

            .title {
                border-radius: 0.9375rem;
            }
        }
    </style>
</a>
